<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postman Collection Checkboxes</title>
</head>
<body>
    <h1>Select Requests</h1>
    
    <!-- Workspace dropdown and Refresh button -->
<div>
    <label for="workspace">Workspace:</label>
    <select id="workspace" name="workspace" onchange="updateCollectionsDropdown();">
        <% workspaces.forEach(workspace => { %>
            <option value="<%= workspace.id %>" <%= workspace.id === selectedWorkspaceId ? 'selected' : '' %>>
                <%= workspace.name %>
            </option>
        <% }) %>
    </select>
    <button type="button" onclick="updateCollectionsDropdown();">Refresh Collections</button> <!-- New button -->
</div>


    <!-- Collections dropdown -->
    <div>
        <label for="collection">Collection:</label>
        <select id="collection" name="collection" onchange="updateCheckboxes();">
            <% collections.forEach(collection => { %>
                <option value="<%= collection.id %>" <%= collection.id === selectedCollectionId ? 'selected' : '' %>>
                    <%= collection.name %>
                </option>
            <% }) %>
        </select>
        <button type="button" onclick="updateCheckboxes();">Refresh Checkboxes</button> <!-- New button -->
    </div>

    <div id="checkboxes">
        <form method="post" action="/create-collection">

            <div id="checkboxesContainer"> <!-- Container for checkboxes -->
                <% if (collectionData) { %>
                    <% requests.forEach(request => { %>
                        <div>
                            <input type="checkbox" id="<%= request %>" name="selectedRequests" value="<%= request %>">
                            <label for="<%= request %>"><%= request.name %></label>
                        </div>
                    <% }) %>
                <% } else { %>
                    <p>Collection not selected.</p>
                <% } %>
            </div>

            <!-- Public Workspaces dropdown -->
            <div>
                <label for="publicWorkspace">Public Workspace To Save New Collection To:</label>
                <select id="publicWorkspace" name="publicWorkspace">
                    <% publicWorkspaces.forEach(workspace => { %>
                        <option value="<%= workspace.id %>">
                            <%= workspace.name %>
                        </option>
                    <% }) %>
                </select>
            </div>

            <input type="hidden" name="publicWorkspaceId" value="<%= publicWorkspaces[0] && publicWorkspaces[0].id %>">
            <button type="submit">Create New Collection</button>

        </form>
    </div>

    <script>
        async function updateCollectionsDropdown() {
            const workspaceId = document.getElementById('workspace').value;
            const collectionsDropdown = document.getElementById('collection');
            
            try {
                const response = await fetch(`/workspaces/${workspaceId}`);
                const workspaceDetails = await response.json();

                const collections = workspaceDetails.collections || [];

                // Clear the dropdown
                collectionsDropdown.innerHTML = '';

                // Populate the dropdown with new collections
                collections.forEach(collection => {
                    const option = document.createElement('option');
                    option.value = collection.id;
                    option.textContent = collection.name;
                    collectionsDropdown.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to update collections dropdown:', error);
            }
        }

        async function updateCheckboxes() {
            const collectionId = document.getElementById('collection').value;
            const checkboxesContainer = document.getElementById('checkboxesContainer');
            
            try {
                const response = await fetch(`/collections/${collectionId}`);
                const collectionData = await response.json();

                //const requests = collectionData.item.map(item => item.name);
                const requests = collectionData.item;
                jsonString = JSON.stringify(requests, null, 2)?.replaceAll('\\', '');
                console.log(`requests at this point requests: ${JSON.stringify(jsonString, null, 2)}`);
                // Clear the existing checkboxes
                checkboxesContainer.innerHTML = '';

                // Populate the div with new checkboxes
                requests.forEach(request => {
                    const checkboxDiv = document.createElement('div');

                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = request;
                    input.name = 'selectedRequests';
                    //input.textContent = request.name;
                    input.value = request;

                    const label = document.createElement('label');
                    label.htmlFor = request.name;
                    label.textContent = request.name;

                    checkboxDiv.appendChild(input);
                    checkboxDiv.appendChild(label);
                    checkboxesContainer.appendChild(checkboxDiv);
                });
            } catch (error) {
                console.error('Failed to update checkboxes:', error);
            }
        }
    </script>
</body>
</html>
